import tkinter as tk
from tkinter import filedialog
from tkinter import ttk
import re
import pandas as pd 
from functools import reduce
import numpy as np

def check_file_extension(file_path):
    if re.search(r"\.xlsx$", file_path, re.IGNORECASE):
        return "xlsx"
    elif re.search(r"\.csv$", file_path, re.IGNORECASE):
        return "csv"
    else:
        return None


def upload_file():
    
    filetypes = [("Arquivos CSV", "*.csv"), ("Arquivo XLSX", "*.xlsx")]
    file_path = filedialog.askopenfilename(filetypes=filetypes)
    
    extension = check_file_extension(file_path)
    if extension == "csv":
        print("O arquivo é um arquivo XLSX.")
        df = pd.read_csv(file_path)  # Para CSV
        id_dados(df)
    elif extension == "xlsx":
        print("O arquivo é um arquivo CSV.")
        df = pd.read_excel(file_path)  # Para XLSX
        id_dados(df,file_path)
    else:
        print("O arquivo não possui uma extensão válida.")
        
    
def id_dados(df, file_path):
    # Processar os dados e aplicar o método WISP
    
    df = pd.read_excel(file_path)
    
    colunas = df.columns.tolist()

    qnt_colunas = len(colunas)

    list_PorC = df.iloc[0].values.tolist()
    list_Weight = df.iloc[1].values.tolist()
    list_Weight.pop(0)
    list_PorC.pop(0)
    primeira_coluna = df.iloc[2:, 0].reset_index(drop=True)
    
    
    indices_remover = [0, 1]
    dfr = df.drop(indices_remover)
    dfr = dfr.drop(columns=dfr.columns[0]) 


    for i in range(1, qnt_colunas-1):
        dfr.iloc[:, i] = pd.to_numeric(dfr.iloc[:, i])

    df_vazio = pd.DataFrame()

    for j in range(0, qnt_colunas-1):
        for i in range(len(dfr)):
            maior_valor = dfr.iloc[:, j].max()
            valor = dfr.iloc[i, j]
            df_vazio.at[i, j] = valor/maior_valor


    dfff = pd.DataFrame()
    for i in range(len(df_vazio)):
        
        linha = df_vazio.iloc[i]  # Seleciona a primeira linha do DataFrame
        lista = linha.tolist()

        resultado = np.multiply(list_Weight, lista).tolist()
    
        dicionario = {f'{colunas[i+1]}': valor for i, valor in enumerate(resultado)}
    
        # Adiciona o dicionário como uma nova linha no DataFrame
        dfff = dfff.append(dicionario, ignore_index=True)


    dfff.insert(0, colunas[0], primeira_coluna)

    df_Ui = pd.DataFrame()

    for j in range(len(dfff)):
        resultado1 = []
        resultado2 = []
        for i in range(1, qnt_colunas):

            if list_PorC[i-1] == 'P':
                valor = dfff.iloc[j,i]
                resultado1.append(valor)
                #df_Ui.at[i, j] = resultado
    
            if list_PorC[i-1] == 'C':
                valor2 = dfff.iloc[j,i]
                resultado2.append(valor2)
        
        
        Uiwsd = reduce(lambda x, y: x + y, resultado1) - reduce(lambda x, y: x + y, resultado2)
        Uiwpd = reduce(lambda x, y: x * y, resultado1) - reduce(lambda x, y: x * y, resultado2)
        Uiwsr = reduce(lambda x, y: x + y, resultado1) / reduce(lambda x, y: x + y, resultado2)
        Uiwpr = reduce(lambda x, y: x * y, resultado1) / reduce(lambda x, y: x * y, resultado2)
    
        df_Ui.at[j, "Uiwsd"] = Uiwsd
        df_Ui.at[j, "Uiwpd"] = Uiwpd
        df_Ui.at[j, "Uiwsr"] = Uiwsr
        df_Ui.at[j, "Uiwpr"] = Uiwpr

    maior_valor_Uiwsd = df_Ui.iloc[:, 0].max()
    maior_valor_Uiwpd = df_Ui.iloc[:, 1].max()
    maior_valor_Uiwsr = df_Ui.iloc[:, 2].max()
    maior_valor_Uiwpr = df_Ui.iloc[:, 3].max()

    df_Uii = pd.DataFrame()

    df_Uii["Uiwsd"] = df_Ui["Uiwsd"] / (1 + maior_valor_Uiwsd)
    df_Uii["Uiwpd"] = df_Ui["Uiwpd"] / (1 + maior_valor_Uiwpd)
    df_Uii["Uiwsr"] = df_Ui["Uiwsr"] / (1 + maior_valor_Uiwsr)
    df_Uii["Uiwpr"] = df_Ui["Uiwpr"] / (1 + maior_valor_Uiwpr)

    df_Uii["Absolute Value"] = (df_Uii["Uiwsd"] + df_Uii["Uiwpd"] + df_Uii["Uiwsr"] + df_Uii["Uiwpr"])/4

    df_Uii.insert(0, colunas[0], primeira_coluna)

    df_Uii = df_Uii.sort_values(by="Absolute Value", ascending=False)
    df_Uii = df_Uii.reset_index(drop=True)

    df_Uii["Ranking"] = df_Uii.index + 1

    df_Uii.index += 1  # Incrementa o índice em 1 para começar de 1
    df_Uii.rename(columns={'index': 'Ranking'}, inplace=True)  # Renomeia a coluna do índice para "Ranking"
    df_Uii.reset_index(inplace=False)

    salvar(file_path)

def salvar(file_path):
    
    # Salvar o arquivo
    
    padrao = r'(.*)/'  # Regex para capturar todo o texto antes do último caractere '\'

    resultado = re.match(padrao, file_path)

    if resultado:
        caminho = resultado.group(1)
        df_Uii.to_excel(caminho + r'\File - Wisp Ranking.xlsx', index=False)
    else:
        print('Padrão não encontrado.')
    

def get_values():
    values = []
    for i in range(num_alternatives):
        row_values = []
        for j in range(num_criteria):
            value = entry_values[i][j].get()
            row_values.append(value)
        values.append(row_values)
    # Processar os valores inseridos e realizar os cálculos do método CRITIC-MOORA-3N


def create_main_window():
    main_window = tk.Tk()
    main_window.title("CRITIC-MOORA-3N")
    main_window.geometry("400x200")

    upload_button = tk.Button(main_window, text="Upload de arquivo", command=upload_file)
    upload_button.pack(pady=20)

    main_window.mainloop()

create_main_window()

